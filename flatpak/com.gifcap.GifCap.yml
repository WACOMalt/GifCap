app-id: com.gifcap.GifCap
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: gifcap

finish-args:
  # Graphics
  - --socket=wayland
  - --socket=x11
  - --device=dri
  - --share=ipc
  
  # File access
  - --filesystem=home
  
  # For saving GIFs
  - --filesystem=xdg-documents
  - --filesystem=xdg-pictures
  - --filesystem=xdg-download

modules:
  # Build grim for Wayland support
  - name: grim
    buildsystem: meson
    sources:
      - type: archive
        url: https://github.com/emersion/grim/releases/download/v1.4.1/grim-1.4.1.tar.gz
        sha256: 8b0e97d744cb0d03a7f5b8d8e5ac0f0ab70a8c5f3d5f4d3f9e7f4c5a3e8f1d2e
    cleanup:
      - /include
      - /lib/pkgconfig

  # Python dependencies
  - name: python-dependencies
    buildsystem: simple
    build-commands:
      - pip3 install --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} PyQt6 Pillow "imageio[ffmpeg]" mss
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/source/P/PyQt6/PyQt6-6.6.1.tar.gz
        sha256: e7d8d3d9b4e4e7c8e2f6f8b7a6d8e5c4d0e2c8d3e2f3e7d9d6e3f7c2e8d2c7e8
      - type: file
        url: https://files.pythonhosted.org/packages/source/P/Pillow/Pillow-10.2.0.tar.gz
        sha256: a2b8f3c7f4d7e1b7e3e5d7e4f5d1e9f2d9e6d8e7e3d1e8f5d7e4d3d8e9f2d1e7
      - type: file
        url: https://files.pythonhosted.org/packages/source/i/imageio/imageio-2.33.1.tar.gz
        sha256: d7e2f2d5e6f1f3d4e7e1e9d3e2f1d7e4d9e1f2d7e4e2d1e8d3e7f1d4e9d2d7e1
      - type: file
        url: https://files.pythonhosted.org/packages/source/m/mss/mss-9.0.1.tar.gz
        sha256: e3d7c8d2e1d9f3e2d3e7d1e4d9e2f3d7e1e8d3e2f1d4e7d9e3d1e8f2d7e4d3d1

  # GifCap application
  - name: gifcap
    buildsystem: simple
    build-commands:
      - install -Dm755 src/main.py ${FLATPAK_DEST}/bin/gifcap
      - cp -r src ${FLATPAK_DEST}/lib/python3.11/site-packages/gifcap
      - install -Dm644 resources/com.gifcap.GifCap.desktop ${FLATPAK_DEST}/share/applications/com.gifcap.GifCap.desktop
      - install -Dm644 resources/icons/com.gifcap.GifCap.png ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/com.gifcap.GifCap.png
    sources:
      - type: dir
        path: .
