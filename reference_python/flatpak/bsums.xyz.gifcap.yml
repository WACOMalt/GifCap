app-id: bsums.xyz.gifcap
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: gifcap

finish-args:
  # Graphics
  - --socket=wayland
  - --socket=x11
  - --device=dri
  - --share=ipc
  
  # File access
  - --filesystem=home
  
  # For saving GIFs
  - --filesystem=xdg-documents
  - --filesystem=xdg-pictures
  - --filesystem=xdg-download
  
  # Force loading of bundled Qt6 libraries
  - --env=LD_LIBRARY_PATH=/app/lib/python3.12/site-packages/PyQt6/Qt6/lib

modules:
  # Build grim for Wayland support
  - name: grim
    buildsystem: meson
    sources:
      - type: git
        url: https://github.com/emersion/grim.git
        tag: v1.4.0
    cleanup:
      - /include
      - /lib/pkgconfig

  # Python dependencies - using pre-built wheels to avoid build dependency issues
  - name: python-dependencies
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} *.whl
    sources:
      # PyQt6 - Qt bindings for Python
      - type: file
        url: https://files.pythonhosted.org/packages/e4/d3/8789879c05cfe06127c4b59258632bd175fcdd9eaaadaf0c897b458fb91d/PyQt6-6.7.1-1-cp38-abi3-manylinux_2_28_x86_64.whl
        sha256: c2f202b7941aa74e5c7e1463a6f27d9131dbc1e6cabe85571d7364f5b3de7397
      
      # PyQt6-sip - SIP bindings for PyQt6
      - type: file
        url: https://files.pythonhosted.org/packages/dd/4d/e263f045c97c2398fbd762d07295140b628a611da5f37744324080a86a1d/PyQt6_sip-13.9.1-cp312-cp312-manylinux_2_5_x86_64.manylinux1_x86_64.whl
        sha256: c1942e107b0243ced9e510d507e0f27aeea9d6b13e0a1b7c06fd52a62e0d41f7
      
      # PyQt6-Qt6 - Qt6 runtime binaries (required by PyQt6)
      - type: file
        url: https://files.pythonhosted.org/packages/88/4d/26ca7239f7223e5b95b58a58537a09b069582ebb4dfa38234113a9f898ab/PyQt6_Qt6-6.7.3-py3-none-manylinux_2_28_x86_64.whl
        sha256: cb525fdd393332de60887953029276a44de480fce1d785251ae639580f5e7246
      
      # Pillow - Image processing
      - type: file
        url: https://files.pythonhosted.org/packages/7f/42/6e0f2c2d5c60f499aa29be14f860dd4539de322cd8fb84ee01553493fb4d/pillow-11.0.0-cp312-cp312-manylinux_2_28_x86_64.whl
        sha256: 00177a63030d612148e659b55ba99527803288cea7c75fb05766ab7981a8c1b7
      
      # imageio - Image I/O library
      - type: file
        url: https://files.pythonhosted.org/packages/c0/69/3aaa69cb0748e33e644fda114c9abd3186ce369edd4fca11107e9f39c6a7/imageio-2.33.1-py3-none-any.whl
        sha256: c5094c48ccf6b2e6da8b4061cd95e1209380afafcbeae4a4e280938cce227e1d
      
      # mss - Screen capture library
      - type: file
        url: https://files.pythonhosted.org/packages/1c/22/e61c6c9fa3730f5ac816f12514947ebfbd42340c56807a7a81b4b7cd5786/mss-9.0.1-py3-none-any.whl
        sha256: 7ee44db7ab14cbea6a3eb63813c57d677a109ca5979d3b76046e4bddd3ca1a0b
      
      # numpy - Required by imageio
      - type: file
        url: https://files.pythonhosted.org/packages/d9/7d/9c8a781c88933725445a859cac5d01b5871588a15969ee6aeb618ba99eee/numpy-2.4.1-cp312-cp312-manylinux_2_27_x86_64.manylinux_2_28_x86_64.whl
        sha256: 7ad270f438cbdd402c364980317fb6b117d9ec5e226fff5b4148dd9aa9fc6e02

  # GifCap application
  - name: gifcap
    buildsystem: simple
    build-commands:
      - install -Dm755 src/main.py ${FLATPAK_DEST}/bin/gifcap
      - cp -r src ${FLATPAK_DEST}/lib/python3.12/site-packages/gifcap
      - install -Dm644 resources/bsums.xyz.gifcap.desktop ${FLATPAK_DEST}/share/applications/bsums.xyz.gifcap.desktop
      - install -Dm644 resources/icons/bsums.xyz.gifcap.png ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/bsums.xyz.gifcap.png
    sources:
      - type: dir
        path: ..
